<!DOCTYPE html>
<html lang="en">
	{% include head.html critical-css="critical-blog.css" content-type="website" %}
    <body class="blog-body">
        {% include blog-masthead.html %}
        <div id="pull-to-refresh" class="pull-to-refresh start-pull hidden-pull">    
            <div id="pull-to-refresh-loader" class="pull-to-refresh-loader"></div>
            <div id="pull-to-refresh-status" class="pull-to-refresh-status">
                Pull down to refresh
            </div>
        </div>    
        <div class="container blog-posts start-pull pullable-content">
			{% include blog-header.html %}
            <div class="blog-main">
                <div class="blog-posts-list">
                    {% for post in paginator.posts %}
                    <div class="blog-posts-post">
                        <a href="{{post.url}}" class="blog-posts-post-link">
                            <span class="blog-posts-post-title">{{post.title}}</span>
                            <div class="blog-posts-post-img-container">
                                {% include blog-lazy-image.html class="img blog-posts-post-img" src=post.image description=post.title %}
                            </div>
                            {% include blog-post-authors.html authors=post.authors enableUrl=false %}
                            {% include blog-post-meta.html post=post %}
                            <span class="blog-posts-post-description">{{post.description}}</span>
                        </a>
                    </div>
                    {% endfor %}
                </div>
                <div class="d-flex flex-row justify-content-center">
                    {% if paginator.previous_page %}
					<a class="btn btn-primary blog-pages-button" href="{{ paginator.previous_page_path }}">Previous</a>
                    {% endif %}
                    {% if paginator.next_page %}
					<a class="btn btn-primary blog-pages-button" href="{{ paginator.next_page_path }}">Next</a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% include footer.html %}
		{% include style.html styleInclude="dependencies-css-blog-home.html" %}
        {% include dependencies-js-blog.html %}
            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', () => {
                    class TouchCoordinates {
                        constructor (x, y) {
                            this.x = x
                            this.y = y
                        }
                    }

                    let startPoint = new TouchCoordinates(0, 0)
                    let currentPoint = new TouchCoordinates(0, 0)
                    const pullToRefreshElement = document.querySelector("#pull-to-refresh")
                    const pullToRefreshStatusElement = document.querySelector("#pull-to-refresh-status")
                    const pullToRefreshLoaderElement = document.querySelector("#pull-to-refresh-loader")
                    const blogBody = document.querySelector(".container.blog-posts")
                    let isLoading = false

                    const sendMessageToServiceWoker = (message) => {
                        return new Promise((resolve, reject) => {
                            const messageChannel = new MessageChannel();
                            messageChannel.port1.onmessage = (event) => {
                                if (event.data.error) {
                                    reject(event.data.error);
                                } else {
                                    resolve(event.data);
                                }
                            };
                            navigator.serviceWorker.controller.postMessage(message, [messageChannel.port2]);
                        });
                    } 
                    
                    const getTouchesCoordinatesFrom = (event) => {
                        if(typeof event['targetTouches'] !== undefined) {
                            return new TouchCoordinates(
                                event.targetTouches[0].screenX,
                                event.targetTouches[0].screenY
                            )
                        } else {
                            return new TouchCoordinates(
                                event.screenX,
                                event.screenY
                            )
                        }
                    }
                    
                    document.addEventListener('touchstart', (e) => {
                        startPoint = getTouchesCoordinatesFrom(e)                        
                        pullToRefreshElement.classList.add("start-pull")
                        pullToRefreshElement.classList.remove("end-pull")
                        blogBody.classList.add("start-pull")
                        blogBody.classList.remove("end-pull")
                    })

                    document.addEventListener('touchmove', (e) => {
                        currentPoint = getTouchesCoordinatesFrom(e)
                        const changeY = Math.abs(startPoint.y - currentPoint.y)
    
                        if(window.scrollY <= 0 && startPoint.y - currentPoint.y <= 0) {
                            e.preventDefault();
                            pullToRefreshElement.classList.add("visible-pull")
                            pullToRefreshElement.classList.remove("hidden-pull")
    
                            if (changeY < 100) {
                                pullToRefreshElement.style.transform = `translateY(-${100 - changeY}px)`
                                pullToRefreshLoaderElement.style.opacity = changeY/100;
                                blogBody.style.transform = `translateY(-${100 - changeY}px)`
                            } else {
                                pullToRefreshElement.style.transform = `translateY(0px)`
                                blogBody.style.transform = `translateY(0px)`
                            }
    
                            if(changeY >= 100 && !isLoading) {
                                isLoading = true
                                pullToRefreshStatusElement.innerHTML = "Refreshing"
                                pullToRefreshLoaderElement.classList.add("animate")
                                sendMessageToServiceWoker({message: "refresh", url: window.location.href}).then((data) => {
                                    setTimeout(() => {
                                        isLoading = false
                                        pullToRefreshStatusElement.innerHTML = "Refresh completed"
                                        pullToRefreshElement.classList.add("end-pull")
                                        pullToRefreshElement.classList.add("hidden-pull")
                                        pullToRefreshElement.classList.remove("visible-pull")
                                        blogBody.classList.add("end-pull")
                                        pullToRefreshElement.style.transform = ``
                                        blogBody.style.transform = ``
                                        pullToRefreshLoaderElement.style.opacity = 0;
                                    }, 2000)
                                }).catch((error) => console.log(error))
                            }
                        }
                    }, {passive: false})
    
                    document.addEventListener('touchend', (e) => {
                        if(!isLoading) {
                            pullToRefreshElement.classList.add("end-pull")
                            blogBody.classList.add("end-pull")
                            pullToRefreshElement.style.transform = ``
                            blogBody.style.transform = ``
                            pullToRefreshLoaderElement.style.opacity = 0;
                        }
                    })
    
                    const endTransitionEvent = () => {
                        var t;
                        var el = document.createElement('fakeelement');
                        var transitions = {
                            'transition':'transitionend',
                            'OTransition':'oTransitionEnd',
                            'MozTransition':'transitionend',
                            'WebkitTransition':'webkitTransitionEnd'
                        }
    
                        for(t in transitions){
                            if( el.style[t] !== undefined ){
                                return transitions[t];
                            }
                        }
                    }
    
                    pullToRefreshElement.addEventListener(endTransitionEvent(), function() {
                        pullToRefreshStatusElement.innerHTML = "Pull down to refresh"
                        pullToRefreshLoaderElement.classList.remove("animate")
                        window.location.reload()                            
                    });
                })
            </script>
    </body>
</html>
